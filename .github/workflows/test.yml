name: Test

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
        description: 'Operating system to run tests on'
      display-name:
        required: true
        type: string
        description: 'Display name for the test job'

permissions:
  contents: read

jobs:
  test:
    name: ${{ inputs.display-name }} (${{ matrix.python-version }})
    runs-on: ${{ inputs.os }}
    permissions:
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: ./.github/actions/setup-virtualenv
        id: setup-virtualenv
        with:
          cache-prefix: test
          python-version: ${{ matrix.python-version }}
          uv-sync-args: "--all-extras --dev"

      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: stable
          cache-key: test-${{ runner.os }}-${{ matrix.python-version }}

      - id: rust-version-checksum
        run: echo "version-sha256sum=$(rustc --version | sha256sum | cut -d ' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Cache `~/.cargo`
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}|cargo|${{ steps.setup-virtualenv.outputs.python-version-checksum }}|${{ steps.rust-version-checksum.outputs.version-sha256sum }}|${{ hashFiles('Cargo.toml', 'Cargo.lock') }}

      - name: Cache Rust `target/release`
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            target/release
          key: ${{ runner.os }}|target|release|${{ steps.setup-virtualenv.outputs.python-version-checksum }}|${{ steps.rust-version-checksum.outputs.version-sha256sum }}|${{ hashFiles('Cargo.toml', 'Cargo.lock') }}

      - name: Cache Rust `target/coverage`
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            target/coverage
          key: ${{ runner.os }}|target|coverage|${{ steps.setup-virtualenv.outputs.python-version-checksum }}|${{ steps.rust-version-checksum.outputs.version-sha256sum }}|${{ hashFiles('Cargo.toml', 'Cargo.lock') }}

      - name: Build Rust Release
        run: |
          cargo build --release --target-dir target/release

      - name: Run Python Tests
        env:
          PYTHONPATH: "${{ github.workspace }}/tests/support/coverage"
          COVERAGE_PROCESS_START: "${{ github.workspace }}${{ runner.os == 'Windows' && '\\' || '/' }}.coveragerc"
        run: |
          uv run coverage run -m pytest -ra -s -v --color=yes --junitxml=junit-${{ matrix.python-version }}-${{ inputs.os }}.xml

      - name: Report Python Coverage
        run: |
          uv run coverage combine || true
          uv run coverage xml
          uv run coverage report

      - name: Install Tarpaulin
        run: |
          cargo install cargo-tarpaulin --target-dir target/coverage

      - name: Tarpaulin Build
        run: |
          cargo tarpaulin --no-run --target-dir target/coverage

      - name: Run Rust Tests
        run: |
          cargo tarpaulin --workspace --tests --skip-clean --timeout 120 --out Xml --out Json --output-dir target/coverage

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          # Use OpenID Connect for secure authentication (no token needed)
          use_oidc: true
          flags: ${{ inputs.os }},${{ matrix.python-version }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # v1.1.1
        with:
          # Use OpenID Connect for secure authentication (no token needed)
          use_oidc: true
          flags: ${{ inputs.os }},${{ matrix.python-version }}
